<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparative Analytics | KCS</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #0f172a; --accent: #3b82f6; --success: #10b981; --danger: #ef4444; --bg: #f8fafc; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--primary); padding: 20px; margin: 0; }
        
        .report-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .card { background: white; padding: 25px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .full-width { grid-column: span 2; }

        .delta-badge { padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 700; margin-left: 10px; }
        .pos { background: #dcfce7; color: #15803d; }
        .neg { background: #fee2e2; color: #b91c1c; }

        /* Leaderboard Styling */
        .rank-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #f1f5f9; }
        .rank-number { width: 30px; font-weight: 800; color: #94a3b8; }
        .rank-info { flex: 1; }
        .rank-value { font-weight: 700; text-align: right; }
        
        .gold { color: #fbbf24; } /* 1st Place Icon */

        @media (max-width: 768px) { .report-grid { grid-template-columns: 1fr; } .full-width { grid-column: span 1; } }
    </style>
</head>
<body>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <div>
            <h2 style="margin:0">Performance Comparison Report</h2>
            <p style="color:#64748b; margin:5px 0;">Comparing Current vs. Previous Month Metrics</p>
        </div>
        <input type="month" id="reportMonth" onchange="generateReport()" style="padding:10px; border-radius:8px; border:1px solid #ccc;">
    </div>

    <div class="report-grid">
        <div class="card">
            <h3 style="margin-top:0; font-size: 1rem; color:#64748b;">REVENUE COMPARISON</h3>
            <div style="display:flex; align-items:baseline;">
                <span id="currTotal" style="font-size:2rem; font-weight:800;">K0.00</span>
                <span id="revDelta" class="delta-badge">0%</span>
            </div>
            <p style="font-size:13px; color:#94a3b8;" id="prevComparisonText">vs K0.00 last month</p>
        </div>

        <div class="card">
            <h3 style="margin-top:0; font-size: 1rem; color:#64748b;">SHOP ACTIVITY GAP</h3>
            <div style="display:flex; align-items:baseline;">
                <span id="currEntries" style="font-size:2rem; font-weight:800;">0</span>
                <span id="entryDelta" class="delta-badge">0%</span>
            </div>
            <p style="font-size:13px; color:#94a3b8;">Total Transactions recorded</p>
        </div>

        <div class="card">
            <h3 style="margin-top:0;"><i class="fa-solid fa-trophy gold"></i> Staff Power Ranking</h3>
            <div id="leaderboard">
                </div>
        </div>

        <div class="card">
            <h3 style="margin-top:0;">Output Distribution</h3>
            <div style="height: 250px;">
                <canvas id="rankChart"></canvas>
            </div>
        </div>
    </div>

    

<script>
    let myChart = null;

    function generateReport() {
        const selectedMonth = document.getElementById('reportMonth').value;
        const records = JSON.parse(localStorage.getItem('barber_master_records')) || [];
        
        // Calculate Previous Month
        const date = new Date(selectedMonth + "-01");
        date.setMonth(date.getMonth() - 1);
        const prevMonth = date.toISOString().substring(0, 7);

        const currData = records.filter(r => r.date.startsWith(selectedMonth));
        const prevData = records.filter(r => r.date.startsWith(prevMonth));

        // Totals
        const currRev = currData.reduce((acc, r) => r.category === 'income' ? acc + r.amount : acc, 0);
        const prevRev = prevData.reduce((acc, r) => r.category === 'income' ? acc + r.amount : acc, 0);

        // Update UI
        document.getElementById('currTotal').innerText = `K${currRev.toFixed(2)}`;
        document.getElementById('prevComparisonText').innerText = `vs K${prevRev.toFixed(2)} in ${prevMonth}`;
        
        const revChange = prevRev === 0 ? 100 : ((currRev - prevRev) / prevRev * 100);
        const revBadge = document.getElementById('revDelta');
        revBadge.innerText = `${revChange >= 0 ? '+' : ''}${revChange.toFixed(1)}%`;
        revBadge.className = `delta-badge ${revChange >= 0 ? 'pos' : 'neg'}`;

        // Ranking Logic
        const staff = ["PRINCE CHANSA", "FEWDAYS KALEMBWE", "DAVIES CHIBAWA", "RUEBEN KALILWA"];
        let ranking = staff.map(name => {
            const staffWork = currData.filter(r => r.customer === name && r.category === 'income');
            const total = staffWork.reduce((acc, r) => acc + r.amount, 0);
            return { name, total };
        }).sort((a, b) => b.total - a.total);

        const leaderboard = document.getElementById('leaderboard');
        leaderboard.innerHTML = ranking.map((s, i) => `
            <div class="rank-item">
                <div class="rank-number">#${i+1}</div>
                <div class="rank-info">
                    <strong>${s.name}</strong><br>
                    <small style="color:#64748b">${((s.total/currRev)*100 || 0).toFixed(1)}% of shop output</small>
                </div>
                <div class="rank-value">K${s.total.toFixed(2)}</div>
            </div>
        `).join('');

        updateChart(ranking);
    }

    function updateChart(data) {
        const ctx = document.getElementById('rankChart').getContext('2d');
        if (myChart) myChart.destroy();

        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.map(s => s.name.split(' ')[0]),
                datasets: [{
                    label: 'Gross Output (K)',
                    data: data.map(s => s.total),
                    backgroundColor: ['#0f172a', '#3b82f6', '#94a3b8', '#cbd5e1'],
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true } }
            }
        });
    }

    window.onload = () => {
        document.getElementById('reportMonth').value = new Date().toISOString().substring(0, 7);
        generateReport();
    };
</script>
</body>
</html>